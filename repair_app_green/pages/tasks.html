<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="HandheldFriendly" content="true" />
		<meta name="MobileOptimized" content="320" />
		<!--<link rel="stylesheet" href="../css/index.css" />-->
		<script type="text/javascript" src="../js/mui.js"></script>
		<script type="text/javascript" src="../js/common.js"></script>
		<script type="text/javascript" src="../js/libs/vue.min.js"></script>
		<script type="text/javascript" src="../js/index.js"></script>
		<link rel="stylesheet" href="../css/mui.min.css" />
		<link rel="stylesheet" href="../css/audio.css" />
		<link rel="stylesheet" href="../css/common.css" />
		<style type="text/css">
			.mui-preview-image.mui-fullscreen {
				position: fixed;
				z-index: 20;
				background-color: #000;
			}
			
			.mui-preview-header,
			.mui-preview-footer {
				position: absolute;
				width: 100%;
				left: 0;
				z-index: 10;
			}
			
			.mui-preview-header {
				height: 44px;
				top: 0;
			}
			
			.mui-preview-footer {
				height: 50px;
				bottom: 0px;
			}
			
			.mui-preview-header .mui-preview-indicator {
				display: block;
				line-height: 25px;
				color: #fff;
				text-align: center;
				margin: 15px auto 4;
				width: 70px;
				background-color: rgba(0, 0, 0, 0.4);
				border-radius: 12px;
				font-size: 16px;
			}
			
			.mui-preview-image {
				display: none;
				-webkit-animation-duration: 0.5s;
				animation-duration: 0.5s;
				-webkit-animation-fill-mode: both;
				animation-fill-mode: both;
			}
			
			.mui-preview-image.mui-preview-in {
				-webkit-animation-name: fadeIn;
				animation-name: fadeIn;
			}
			
			.mui-preview-image.mui-preview-out {
				background: none;
				-webkit-animation-name: fadeOut;
				animation-name: fadeOut;
			}
			
			.mui-preview-image.mui-preview-out .mui-preview-header,
			.mui-preview-image.mui-preview-out .mui-preview-footer {
				display: none;
			}
			
			.mui-zoom-scroller {
				position: absolute;
				display: -webkit-box;
				display: -webkit-flex;
				display: flex;
				-webkit-box-align: center;
				-webkit-align-items: center;
				align-items: center;
				-webkit-box-pack: center;
				-webkit-justify-content: center;
				justify-content: center;
				left: 0;
				right: 0;
				bottom: 0;
				top: 0;
				width: 100%;
				height: 100%;
				margin: 0;
				-webkit-backface-visibility: hidden;
			}
			
			.mui-zoom {
				-webkit-transform-style: preserve-3d;
				transform-style: preserve-3d;
			}
			
			.mui-slider .mui-slider-group .mui-slider-item img {
				width: auto;
				height: auto;
				max-width: 100%;
				max-height: 100%;
			}
			
			.mui-android-4-1 .mui-slider .mui-slider-group .mui-slider-item img {
				width: 100%;
			}
			
			.mui-android-4-1 .mui-slider.mui-preview-image .mui-slider-group .mui-slider-item {
				display: inline-table;
			}
			
			.mui-android-4-1 .mui-slider.mui-preview-image .mui-zoom-scroller img {
				display: table-cell;
				vertical-align: middle;
			}
			
			.mui-preview-loading {
				position: absolute;
				width: 100%;
				height: 100%;
				top: 0;
				left: 0;
				display: none;
			}
			
			.mui-preview-loading.mui-active {
				display: block;
			}
			
			.mui-preview-loading .mui-spinner-white {
				position: absolute;
				top: 50%;
				left: 50%;
				margin-left: -25px;
				margin-top: -25px;
				height: 50px;
				width: 50px;
			}
			
			.mui-preview-image img.mui-transitioning {
				-webkit-transition: -webkit-transform 0.5s ease, opacity 0.5s ease;
				transition: transform 0.5s ease, opacity 0.5s ease;
			}
			
			@-webkit-keyframes fadeIn {
				0% {
					opacity: 0;
				}
				100% {
					opacity: 1;
				}
			}
			
			@keyframes fadeIn {
				0% {
					opacity: 0;
				}
				100% {
					opacity: 1;
				}
			}
			
			@-webkit-keyframes fadeOut {
				0% {
					opacity: 1;
				}
				100% {
					opacity: 0;
				}
			}
			
			@keyframes fadeOut {
				0% {
					opacity: 1;
				}
				100% {
					opacity: 0;
				}
			}
			
			p img {
				max-width: 100%;
				height: auto;
			}
			
			.mui-bar {
				height: 43px;
				background-color: #12B482;
			}
			
			.mui-title {
				line-height: 44px;
				color: white;
				font-size: 17px;
				letter-spacing: 5px;
			}
			
			body {
				background-color: #efeff4;
			}
			
			a {
				color: white;
			}
			
			.mui-bar .mui-icon {
				padding-top: 9px;
			}
			
			.box {
				background-color: white;
				margin: 3% 2%;
				border: 1px solid rgb(192, 192, 192);
				padding: 20px 15px;
				margin-bottom: 50px;
			}
			
			.box-span {
				color: #696969;
				display: block;
			}
			
			.mui-button-row .btn {
				height: 36px;
				padding: 0;
				width: 95%;
				border-radius: 3px;
				color: #fff;
				margin-bottom: 5px;
				background-color: #12b482;
				border: 1px solid #12b482;
				font-size: 18px;
			}
			
			#recorder {
				font-size: 17px;
				font-weight: normal;
				text-decoration: none;
				display: block;
				text-align: center;
				overflow: hidden;
				text-overflow: ellipsis;
				white-space: nowrap;
				color: #828282;
				background-color: white;
				border: 1px solid #828282;
				padding: .3em 0em;
				width: 85%;
				border-radius: 5px;
				margin: 0px;
			}
			
			.imgAll {
				width: 50%;
				height: 100%;
				background-image: url(../img/uploadpho.png);
				background-repeat: no-repeat;
				background-size: 100% 100%;
			}
			
			#audioAll {
				width: 100%;
				background-color: #12b482;
				color: white;
				text-align: center;
				height: 25px;
				line-height: 25px;
				font-size: 14px;
				letter-spacing: 5px;
				margin-top: 10px;
			}
			
			.noscroll {
				position: fixed;
				top: 0;
				height: 100%;
				overflow: hidden;
			}
			
			i {
				display: block;
				background: #f00;
				border-radius: 50%;
				width: 5px;
				height: 5px;
				top: 30%;
				left: 5px;
				position: absolute;
			}
			
			textarea {
				margin-bottom: 0px;
			}
		</style>
	</head>

	<body>
		<div style="margin-top: 60px;" id="uploads">
			<header class="mui-bar mui-bar-nav">
				<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
				<h1 class="mui-title" id="taskstitle"></h1>
			</header>
			<div class="box">
				<span class="box-span" id="remarkAll">你共可上传4张图片</span>
				<div style="width: 100%;height: 280px;margin-top: 20px;display: flex;flex-direction:column ">
					<div style="flex: 1;margin-bottom: 10px;display: flex;">
						<div class="imgAll" style="margin-right: 10px;" id="signimg01"></div>
						<div style="margin-right: 10px;width: 50%;height: 100%;display: none;position: relative;" id="issignimg01">
							<img src="" data-preview-src="" data-preview-group="1" id="issignimg01src" style="width:100%;height:100%;display:block;">
							<div style="width: 30px;height: 30px;background-color: #808080;line-height: 30px;text-align: center;position: absolute;bottom: 0px;right: 0px;" id="removeImg01">
								<a><span class="mui-icon mui-icon-trash"></span></a>
							</div>
						</div>
						<div class="imgAll" id="signimg02"></div>
						<div style="margin-right: 10px;width: 50%;height: 100%;display: none;position: relative;" id="issignimg02">
							<img src="" data-preview-src="" data-preview-group="2" id="issignimg02src" style="width:100%;height:100%;display:block;">
							<div style="width: 30px;height: 30px;background-color: #808080;line-height: 30px;text-align: center;position: absolute;bottom: 0px;right: 0px;" id="removeImg02">
								<a><span class="mui-icon mui-icon-trash"></span></a>
							</div>
						</div>
					</div>
					<div style="flex: 1;display: flex;">
						<div class="imgAll" style="margin-right: 10px;" id="signimg03"></div>
						<div style="margin-right: 10px;width: 50%;height: 100%;display: none;position: relative;" id="issignimg03">
							<img src="" data-preview-src="" data-preview-group="3" id="issignimg03src" style="width:100%;height:100%;display:block;">
							<div style="width: 30px;height: 30px;background-color: #808080;line-height: 30px;text-align: center;position: absolute;bottom: 0px;right: 0px;" id="removeImg03">
								<a><span class="mui-icon mui-icon-trash"></span></a>
							</div>
						</div>
						<div class="imgAll" id="signimg04"></div>
						<div style="margin-right: 10px;width: 50%;height: 100%;display: none;position: relative;" id="issignimg04">
							<img src="" data-preview-src="" data-preview-group="4" id="issignimg04src" style="width:100%;height:100%;display:block;">
							<div style="width: 30px;height: 30px;background-color: #808080;line-height: 30px;text-align: center;position: absolute;bottom: 0px;right: 0px;" id="removeImg04">
								<a><span class="mui-icon mui-icon-trash"></span></a>
							</div>
						</div>
					</div>
				</div>
				<div id='sound-alert' class="rprogress" style="z-index: 10;">
					<div class="rschedule"></div>
					<div class="r-sigh">!</div>
					<div id="audio-tips" class="rsalert">手指上滑，取消发送</div>
				</div>
				<div style="margin-top: 25px;">
					<div style="width: 100%;display: none;" id="audioAll">
						<span>播放录音</span>
					</div>
					<div class="mui-input-row" style="margin: 0px 0px 10px 0px;" id="textareaDiv">
						<textarea id="textarea" rows="3"></textarea>
					</div>
					<div style="width: 100%;height: 30px;margin: 25px 0px;border-bottom: 1px solid #D3D3D3;position: relative;padding-left: 20px;display: none;" id="isAudioShow">
						<i></i><span>录音时长</span><img src="../img/audios.png" style="margin-left: 15px;width: 9px;"><span style="color: #FFA200;font-size: 15px;" id="totalTime"></span><img src="../img/audioplay.png" style="position: absolute;left: 55%;top: 0%;" id="audioPlay"><img src="../img/audioclose.png" style="position: absolute;left: 55%;display: none;top: 0%;" id="audioclose"><span class="mui-icon mui-icon-closeempty" style="font-weight: bold;font-size: 29px;float: right;line-height: 21px;color: #FFA200;" id="removeAudio"></span>
					</div>
					<div style="float: left;width: 33px;height: 33px;position: relative;margin-right: 10px;" id="taskImgs"><img id="isShowImg" src="../img/taskImg01.png" width="90%" style="margin-top: 2px;" /></div>
					<div class="button" id="recorder">按住录音</div>
					<div style="height: 33px;width: 85%;margin-left: 43px;display: none;" id="textAll">
						<input style="width: 78%;height: 100%;border:none; border-bottom:1px solid #D3D3D3;margin-right: 2%;" id="saveInput" /><button type="button" style="background-color: #CCCCCC;width: 20%;" id="saveTextBut">保存</button>
					</div>
				</div>
			</div>
			<nav class="mui-bar mui-bar-tab" style="background-color: white;">
				<a class="mui-tab-item">
					<div class="mui-button-row" id="goCost">
						<button type="button" class="btn">提交</button>
					</div>
					<div class="mui-button-row" id="isgoCost" style="display: none;">
						<button type="button" class="btn">下一步</button>
					</div>
				</a>
				<a class="mui-tab-item" href="javascript:;">
					<div class="mui-button-row">
						<button type="button" class="mui-action-back btn" style="background-color: white;border: 1px solid rgb(192, 192, 192);color: #696969;">取消</button>
					</div>
				</a>
			</nav>
		</div>
		<script type="text/javascript" src="../js/libs/mui.zoom.js"></script>
		<script type="text/javascript" src="../js/libs/mui.previewimage.js"></script>
		<script type="text/javascript">
			mui.init({
				gestureConfig: {
					tap: true, //默认为true
					drag: true, //默认为true
					hold: true, //默认为false，不监听
					release: true //默认为false，不监听
				}
			});
			mui.previewImage();
			var onlyIds = "";
			var entrys = null;
			var MIN_SOUND_TIME = 800;
			var recorder = null;
			var startTimestamp = null;
			var stopTimestamp = null;
			var stopTimer = null;
			var recordCancel = false;

			var audiopath = "";
			var audioId = "";

			var Lon = "";
			var Lat = "";
			var addr = "";

			var removeImgAll = [];
			var removeAudioId = '';

			var isUpdats = '';

			var imgNumber = 0;
			var audioNumber = 0;
			
			var loccodes = "";

			var soundAlert = document.getElementById("sound-alert");
			var audioTips = document.getElementById("audio-tips");
			var setSoundAlertVisable = function(show) {
				if(show) {
					document.getElementById("sound-alert").style.display = 'block'
					document.getElementById("sound-alert").style.opacity = 1;
					/*document.getElementsByTagName("body")[0].classList.add("noscroll");*/
				} else {
					/*document.getElementsByTagName("body")[0].classList.remove("noscroll");*/
					document.getElementById("sound-alert").style.opacity = 0;
					//  完成再真正隐藏
					setTimeout(function() {
						document.getElementById("sound-alert").style.display = 'none';
					}, 100);
				}
			};

			function uploadVoice(path) {
				var task = plus.uploader.createUpload(api + uploadOrderFile, {
						method: "POST"
					},
					function(t, status) {
						// 上传完成
						var objects = JSON.parse(t.responseText);
						if(objects.success) {
							audioNumber = 1;
							audioId = objects.result.id;
							var times = objects.result.remark;
							document.getElementById("totalTime").innerHTML = times + "S";
							document.getElementById("isAudioShow").style.display = 'block'
						}
					}
				);
				var ss = onlyIds.toString();
				task.addData("orderId", ss);
				task.addFile(path, {
					key: "file"
				});
				task.start();
			}

			/*function backs() {console.log(removeAll);
				
				window.history.back();
			}*/

			mui.back = function() {
				if(removeAll.length > 0 && removeAll != '') {
					for(var i = 0; i < removeAll.length; i++) {
						ajaxs(pictureDelete + "?id=" + removeAll[i], 'get').then(function(response) {
							if(response.success) {}
						}).catch(function(error) {

						})
					}
				}
				if(audioId != '' && isUpdats != true || isUpdats == true && audioNumber == 1) {
					ajaxs(fileDelete + "?id=" + audioId, 'get').then(function(response) {
						if(response.success) {}
					}).catch(function(error) {

					})
				}
				var ws = plus.webview.currentWebview();
				plus.webview.close(ws);
				/*plus.webview.currentWebview().hide();
				plus.webview.currentWebview().close();*/
				return true;
			}

			mui.plusReady(function() {
				/*
				onlyIds = localStorage.getItem("onlyId");
				var states = self.state;
				taskstitle.innerHTML = self.titles*/
				var self = plus.webview.currentWebview();
				isUpdats = self.isUpdata;
				var states = localStorage.getItem("state");
				onlyIds = localStorage.getItem("onlyId");
				taskstitle.innerHTML = localStorage.getItem("titlespar");
				var isAudio = "";
				// 按住录音（长按开始录音）
				document.querySelector('#recorder').addEventListener('hold', function() {
					document.addEventListener('touchmove', preventDefault, {
						passive: false
					});
					isAudio = document.getElementById("isAudioShow").style.display;
					if(isAudio == 'block') {
						mui.toast("已有录音文件,请先删除原有录音");
						return;
					}
					recordCancel = false;
					if(stopTimer) clearTimeout(stopTimer);
					document.getElementById("sound-alert").style.display = 'block'
					document.getElementById("audio-tips").innerHTML = "手指上划，取消发送";
					document.getElementById("sound-alert").classList.remove('rprogress-sigh');
					setSoundAlertVisable(true);

					// 获取当前设备的录音对象
					recorder = plus.audio.getRecorder();
					startTimestamp = (new Date()).getTime();
					recorder.record({
						filename: '_doc/audio/'
					}, function(path) {
						if(recordCancel) return;
						console.log("path:" + path);
						audiopath = path;
						mui.toast('录音完成');
						plus.io.resolveLocalFileSystemURL(path, function(entry) {
							/*uploadVoice(entry);*/
							for(var prop in entry) {
								if("fullPath" == prop) {
									uploadVoice(entry[prop]);
								}
							}
						}, function(e) {
							mui.toast('读取录音文件错误：' + e.message);
						});
					}, function(e) {
						mui.toast("录音出现异常: " + e.message);
					});
				})

				// 释放保存（松手保存）
				document.querySelector('#recorder').addEventListener('release', function() {
					document.removeEventListener('touchmove', preventDefault, {
						passive: false
					});
					if(document.getElementById("audio-tips").classList.contains("cancel")) {
						document.getElementById("audio-tips").classList.remove("cancel");
						document.getElementById("audio-tips").innerHTML = "手指上划，取消发送";
					}
					// 判断录音时间
					stopTimestamp = (new Date()).getTime();
					if(stopTimestamp - startTimestamp < 800) {
						document.getElementById("audio-tips").innerHTML = "录音时间太短";
						document.getElementById("sound-alert").classList.add('rprogress-sigh');
						recordCancel = true;
						stopTimer = setTimeout(function() {
							setSoundAlertVisable(false);
						}, 800);
					} else {
						setSoundAlertVisable(false);
					}
					if(isAudio != 'block') {
						recorder.stop();
					}
				})

				// 拖动屏幕（手指上划，取消发送）
				document.body.addEventListener('drag', function(event) {
					if(Math.abs(event.detail.deltaY) > 50) {
						if(!recordCancel) {
							recordCancel = true;
							if(!document.getElementById("audio-tips").classList.contains("cancel")) {
								document.getElementById("audio-tips").classList.add("cancel");
							}
							document.getElementById("audio-tips").innerHTML = "松开手指，取消发送";
						}
					} else {
						if(recordCancel) {
							recordCancel = false;
							if(document.getElementById("audio-tips").classList.contains("cancel")) {
								document.getElementById("audio-tips").classList.remove("cancel");
							}
							document.getElementById("audio-tips").innerHTML = "手指上划，取消发送";
						}
					}
				}, false);

				document.getElementById('audioPlay').addEventListener('tap', function() {
					startPlay(audiopath);
				})

				document.getElementById('audioclose').addEventListener('tap', function() {
					var player = plus.audio.createPlayer(audiopath);
					stopPlay(player);
					mui.toast('停止播放')
				})

				document.getElementById('removeAudio').addEventListener('tap', function() {
					plus.nativeUI.confirm('确定删除录音？', function(e) {
						if(e.index == "0") {
							console.log(isUpdats);
							if(isUpdats) {
								audioNumber = 0;
								removeAudioId = audioId;
								document.getElementById('isAudioShow').style.display = 'none';
							} else {
								ajaxs(fileDelete + "?id=" + audioId, 'get').then(function(response) {
									if(response.success) {
										mui.toast(response.message);
										document.getElementById('isAudioShow').style.display = 'none';
									}
								}).catch(function(error) {

								})
							}
						}
					}, {
						title: '提示', //确认对话框显示的标题
						buttons: [ //确认对话框上显示的按钮
							"确定", "取消"
						],
						verticalAlign: 'center', //对话框在屏幕中的垂直分享对齐方式,top|center|bottom
					});
				})

				document.getElementById('removeImg01').addEventListener('tap', function() {
					plus.nativeUI.confirm('确定删除图片？', function(e) {
						if(e.index == "0") {
							if(isUpdats) {
								imgNumber--;
								document.getElementById('issignimg01').style.display = 'none';
								document.getElementById('signimg01').style.display = 'block';
								removeImgAll.push(isremove01);
							} else {
								ajaxs(pictureDelete + "?id=" + isremove01, 'get').then(function(response) {
									if(response.success) {
										removeAll.remove(isremove01);
										mui.toast(response.message);
										document.getElementById('issignimg01').style.display = 'none';
										document.getElementById('signimg01').style.display = 'block';
									}
								}).catch(function(error) {

								})
							}
						}
					}, {
						title: '提示', //确认对话框显示的标题
						buttons: [ //确认对话框上显示的按钮
							"确定", "取消"
						],
						verticalAlign: 'center', //对话框在屏幕中的垂直分享对齐方式,top|center|bottom
					});
				})

				document.getElementById('removeImg02').addEventListener('tap', function() {
					plus.nativeUI.confirm('确定删除图片？', function(e) {
						if(e.index == "0") {
							if(isUpdats) {
								imgNumber--;
								document.getElementById('issignimg02').style.display = 'none';
								document.getElementById('signimg02').style.display = 'block';
								removeImgAll.push(isremove02);
							} else {
								ajaxs(pictureDelete + "?id=" + isremove02, 'get').then(function(response) {
									if(response.success) {
										removeAll.remove(isremove02);
										mui.toast(response.message);
										document.getElementById('issignimg02').style.display = 'none';
										document.getElementById('signimg02').style.display = 'block';
									}
								}).catch(function(error) {

								})
							}
						}
					}, {
						title: '提示', //确认对话框显示的标题
						buttons: [ //确认对话框上显示的按钮
							"确定", "取消"
						],
						verticalAlign: 'center', //对话框在屏幕中的垂直分享对齐方式,top|center|bottom
					});
				})

				document.getElementById('removeImg03').addEventListener('tap', function() {
					plus.nativeUI.confirm('确定删除图片？', function(e) {
						if(e.index == "0") {
							if(isUpdats) {
								imgNumber--;
								document.getElementById('issignimg03').style.display = 'none';
								document.getElementById('signimg03').style.display = 'block';
								removeImgAll.push(isremove03);
							} else {
								ajaxs(pictureDelete + "?id=" + isremove03, 'get').then(function(response) {
									if(response.success) {
										removeAll.remove(isremove03);
										mui.toast(response.message);
										document.getElementById('issignimg03').style.display = 'none';
										document.getElementById('signimg03').style.display = 'block';
									}
								}).catch(function(error) {

								})
							}
						}
					}, {
						title: '提示', //确认对话框显示的标题
						buttons: [ //确认对话框上显示的按钮
							"确定", "取消"
						],
						verticalAlign: 'center', //对话框在屏幕中的垂直分享对齐方式,top|center|bottom
					});
				})

				document.getElementById('removeImg04').addEventListener('tap', function() {
					plus.nativeUI.confirm('确定删除图片？', function(e) {
						if(e.index == "0") {
							if(isUpdats) {
								imgNumber--;
								document.getElementById('issignimg04').style.display = 'none';
								document.getElementById('signimg04').style.display = 'block';
								removeImgAll.push(isremove04);
							} else {
								ajaxs(pictureDelete + "?id=" + isremove04, 'get').then(function(response) {
									if(response.success) {
										removeAll.remove(isremove04);
										mui.toast(response.message);
										document.getElementById('issignimg04').style.display = 'none';
										document.getElementById('signimg04').style.display = 'block';
									}
								}).catch(function(error) {

								})
							}
						}
					}, {
						title: '提示', //确认对话框显示的标题
						buttons: [ //确认对话框上显示的按钮
							"确定", "取消"
						],
						verticalAlign: 'center', //对话框在屏幕中的垂直分享对齐方式,top|center|bottom
					});
				})

				var textAlls = "";

				document.getElementById('goCost').addEventListener('tap', function() {
					textAlls = document.getElementById("textarea").value;
					if(removeAll.length == 0) {
						plus.nativeUI.alert('请上传执行任务记录！', function(e) {}, '提示', '确定');
						return;
					} else {
						mui.openWindow({
							url: 'cost.html',
							id: 'cost',
							extras: {
								onlyId: onlyIds,
								textAll: textAlls,
								state: states,
								Lon: Lon,
								Lat: Lat,
								addr: addr,
							},
						})
					}
				})

				document.getElementById('isgoCost').addEventListener('tap', function() {
					textAlls = document.getElementById("textarea").value;
					if(imgNumber == 0) {
						plus.nativeUI.alert('执行任务图片不能为空！', function(e) {}, '提示', '确定');
						return;
					} else {
						mui.openWindow({
							url: 'cost.html',
							id: 'cost',
							extras: {
								onlyId: onlyIds,
								textAll: textAlls,
								removeImgAll: removeImgAll,
								removeAudioId: removeAudioId
							},
							waiting: {
								autoShow: false, //自动显示等待框，默认为true
							}
						})
					}
				})

				/*document.getElementById('taskImgs').addEventListener('tap', function() {
					if(document.getElementById('recorder').style.display == 'block') {
						document.getElementById('recorder').style.display = 'none'
						document.getElementById('textAll').style.display = 'block'
						document.getElementById("isShowImg").src = "../img/taskImg01.png";
					} else {
						document.getElementById('recorder').style.display = 'block'
						document.getElementById('textAll').style.display = 'none'
						document.getElementById("isShowImg").src = "../img/taskImg02.png";
					}
				})*/

				document.getElementById('saveTextBut').addEventListener('tap', function() {
					document.getElementById('textareaDiv').style.display = 'block'
					var a = document.getElementById("saveInput").value;
					if(textAlls == "") {
						textAlls += a;
					} else {
						textAlls += "\r\n" + a;
					}
					document.getElementById("textarea").value = textAlls;
					document.getElementById("saveInput").value = "";
				})
				var state = localStorage.getItem("state");
				var ids = localStorage.getItem("onlyId");
				if(state != "UNEXECUTED") {
					document.getElementById('isgoCost').style.display = 'block'
					document.getElementById('goCost').style.display = 'none'
					var pictAll = [];
					ajaxs(selectByIdwork + "?id=" + ids, 'get').then(function(response) {
						if(response.success) {
							if(response.result.orderContent != null) {
								var string = response.result.orderContent.content;
								string = string.replace("<br>",/\r\n/g)
								string = string.replace("<br>",/\n/g);
								string = string.replace("/&nbsp;/g",/\s/g);
								document.getElementById("textarea").value = string;
							}
							if(response.result.fileInfo != null) {
								document.getElementById('isAudioShow').style.display = 'block';
								var times = response.result.fileInfo.remark;
								audioId = response.result.fileInfo.id;
								document.getElementById("totalTime").innerHTML = times + "S";
								audiopath = api + getAudio + "?fileUrl=" + response.result.fileInfo.fileUrl;
							}
							/*document.getElementById("remarkAll").style.color = 'red';
							if(response.result.remark == null) {
								document.getElementById("remarkAll").innerHTML = '';
							} else {
								var string = response.result.remark;
								string = string.replace(/\r\n/g, "<br>")
								string = string.replace(/\n/g, "<br>");
								string = string.replace(/\s/g, "&nbsp;");
								document.getElementById("remarkAll").innerHTML = string;
							}*/
							pictAll = response.result.pictureInfoList;
							if(pictAll.length > 0) {
								imgNumber = pictAll.length;
								var lengths = pictAll.length;
								if(lengths == 1) {
									document.getElementById('issignimg01').style.display = 'block';
									document.getElementById('signimg01').style.display = 'none';
									isremove01 = response.result.pictureInfoList[0].id;
									document.getElementById("issignimg01src").src = pictures + response.result.pictureInfoList[0].pictureUrl;
								} else if(lengths == 2) {
									document.getElementById('issignimg01').style.display = 'block';
									document.getElementById('signimg01').style.display = 'none';
									document.getElementById('issignimg02').style.display = 'block';
									document.getElementById('signimg02').style.display = 'none';
									isremove01 = response.result.pictureInfoList[0].id;
									isremove02 = response.result.pictureInfoList[1].id;
									document.getElementById("issignimg01src").src = pictures + response.result.pictureInfoList[0].pictureUrl;
									document.getElementById("issignimg02src").src = pictures + response.result.pictureInfoList[1].pictureUrl;
								} else if(lengths == 3) {
									document.getElementById('issignimg01').style.display = 'block';
									document.getElementById('signimg01').style.display = 'none';
									document.getElementById('issignimg02').style.display = 'block';
									document.getElementById('signimg02').style.display = 'none';
									document.getElementById('issignimg03').style.display = 'block';
									document.getElementById('signimg03').style.display = 'none';
									isremove01 = response.result.pictureInfoList[0].id;
									isremove02 = response.result.pictureInfoList[1].id;
									isremove03 = response.result.pictureInfoList[2].id;
									document.getElementById("issignimg01src").src = pictures + response.result.pictureInfoList[0].pictureUrl;
									document.getElementById("issignimg02src").src = pictures + response.result.pictureInfoList[1].pictureUrl;
									document.getElementById("issignimg03src").src = pictures + response.result.pictureInfoList[2].pictureUrl;
								} else {
									document.getElementById('issignimg01').style.display = 'block';
									document.getElementById('signimg01').style.display = 'none';
									document.getElementById('issignimg02').style.display = 'block';
									document.getElementById('signimg02').style.display = 'none';
									document.getElementById('issignimg03').style.display = 'block';
									document.getElementById('signimg03').style.display = 'none';
									document.getElementById('issignimg04').style.display = 'block';
									document.getElementById('signimg04').style.display = 'none';
									isremove01 = response.result.pictureInfoList[0].id;
									isremove02 = response.result.pictureInfoList[1].id;
									isremove03 = response.result.pictureInfoList[2].id;
									isremove04 = response.result.pictureInfoList[3].id;
									document.getElementById("issignimg01src").src = pictures + response.result.pictureInfoList[0].pictureUrl;
									document.getElementById("issignimg02src").src = pictures + response.result.pictureInfoList[1].pictureUrl;
									document.getElementById("issignimg03src").src = pictures + response.result.pictureInfoList[2].pictureUrl;
									document.getElementById("issignimg04src").src = pictures + response.result.pictureInfoList[3].pictureUrl;
								}
								/*for(let index in pictAll){
									document.getElementById('issignimg01').style.display = 'block';
									document.getElementById('signimg01').style.display = 'none';
								}*/
							}
						}
					}).catch(function(error) {

					})
				} else {
					ajaxs(getOrderIsLocal + "?orderId=" + onlyIds, 'get').then(function(response) {
						loccodes = response.result.isLocation.code;
						if(response.result.isLocation.code == "YES") {
							plus.geolocation.getCurrentPosition(MapPoint, function(e) {
								mui.toast("error:" + e.message);
							}, {
								provider: 'gaode'
							})
							/*if(plus.os.name == "Android") {
								var context = plus.android.importClass("android.content.Context");
								var locationManager = plus.android.importClass("android.location.LocationManager");
								var main = plus.android.runtimeMainActivity();
								var mainSvr = main.getSystemService(context.LOCATION_SERVICE);
								androidIsOpen = mainSvr.isProviderEnabled(locationManager.GPS_PROVIDER);
								if(androidIsOpen) {
									plus.geolocation.getCurrentPosition(MapPoint, function(e) {
										mui.toast("error:" + e.message);
									})
								} else {
									plus.nativeUI.alert('需要打开GPS定位,获取您的地理位置！', function(e) {}, '定位服务已关闭', '确定');
								}
								//console.log("android:"+mainSvr.isProviderEnabled(locationManager.GPS_PROVIDER)); 
							} else {
								plus.geolocation.getCurrentPosition(MapPoint, function(e) {
									mui.toast("error:" + e.message);
								})
							}*/
						}
					}).catch(function(error) {

					})
				}
				document.getElementById('signimg01').addEventListener('tap', function() {
					if(mui.os.plus) {
						var a = [{
							title: "拍照"
						}, {
							title: "从手机相册选择"
						}];
						plus.nativeUI.actionSheet({
							title: "上传图片",
							cancel: "取消",
							buttons: a
						}, function(b) { /*actionSheet 按钮点击事件*/
							switch(b.index) {
								case 0:
									break;
								case 1:
									getImage("1"); /*拍照*/
									break;
								case 2:
									galleryImg("1"); /*打开相册*/
									break;
								default:
									break;
							}
						})
					}
				}, false);
				document.getElementById('signimg02').addEventListener('tap', function() {
					if(mui.os.plus) {
						var a = [{
							title: "拍照"
						}, {
							title: "从手机相册选择"
						}];
						plus.nativeUI.actionSheet({
							title: "上传图片",
							cancel: "取消",
							buttons: a
						}, function(b) { /*actionSheet 按钮点击事件*/
							switch(b.index) {
								case 0:
									break;
								case 1:
									getImage("2"); /*拍照*/
									break;
								case 2:
									galleryImg("2"); /*打开相册*/
									break;
								default:
									break;
							}
						})
					}
				}, false);
				document.getElementById('signimg03').addEventListener('tap', function() {
					if(mui.os.plus) {
						var a = [{
							title: "拍照"
						}, {
							title: "从手机相册选择"
						}];
						plus.nativeUI.actionSheet({
							title: "上传图片",
							cancel: "取消",
							buttons: a
						}, function(b) { /*actionSheet 按钮点击事件*/
							switch(b.index) {
								case 0:
									break;
								case 1:
									getImage("3"); /*拍照*/
									break;
								case 2:
									galleryImg("3"); /*打开相册*/
									break;
								default:
									break;
							}
						})
					}
				}, false);
				document.getElementById('signimg04').addEventListener('tap', function() {
					if(mui.os.plus) {
						var a = [{
							title: "拍照"
						}, {
							title: "从手机相册选择"
						}];
						plus.nativeUI.actionSheet({
							title: "上传图片",
							cancel: "取消",
							buttons: a
						}, function(b) { /*actionSheet 按钮点击事件*/
							switch(b.index) {
								case 0:
									break;
								case 1:
									getImage("4"); /*拍照*/
									break;
								case 2:
									galleryImg("4"); /*打开相册*/
									break;
								default:
									break;
							}
						})
					}
				}, false);
			})

			function MapPoint(position) {
				Lon = position.coords.longitude; //获取经度
				Lat = position.coords.latitude; //获取纬度
				var address = position.address;
				addr = address.country + address.province + address.city + address.district + address.street
			}

			Array.prototype.indexOf = function(val) {
				for(var i = 0; i < this.length; i++) {
					if(this[i] == val) return i;
				}
				return -1;
			};

			Array.prototype.remove = function(val) {
				var index = this.indexOf(val);
				if(index > -1) {
					this.splice(index, 1);
				}
			};

			var player = "";

			function startPlay(path) {
				mui.toast("开始播放");
				document.getElementById('audioPlay').style.display = 'none';
				document.getElementById('audioclose').style.display = 'block';
				player = plus.audio.createPlayer(path);
				player.play(function() {
					mui.toast("播放完成");
					stopPlay(player);
				}, function(e) {
					mui.toast("播放失败");
				});
			}

			function preventDefault(e) {
				e.preventDefault();
			}

			// 停止播放
			function stopPlay() {
				document.getElementById('audioPlay').style.display = 'block';
				document.getElementById('audioclose').style.display = 'none';
				player.stop();
				player = "";
			}

			// 拍照添加文件
			function getImage(value) {
				plus.camera.getCamera().captureImage(function(p) { 
					plus.io.resolveLocalFileSystemURL(p, function(entry) { 
						entry.file(function(metadata) {
							for(let index in metadata) {
								if(index == "size") {
									var sizeImg = metadata[index] / 1024 / 1024;
									if(sizeImg > 1.5) {
										compressImage(entry.toLocalURL(), entry.name, value)
									} else {
										upload(entry.toLocalURL(), value);
									}
								}
							}
						}, function(e) {

						});
					}, function(e) {          
						mui.toast("读取拍照文件错误：" + e.message);        
					}); 
				});
			}

			// 从相册添加文件
			function galleryImg(value) {
				plus.gallery.pick(function(p) {
					plus.io.resolveLocalFileSystemURL(p, function(entry) { 
						entry.file(function(metadata) {
							for(let index in metadata) {
								if(index == "size") {
									var sizeImg = metadata[index] / 1024 / 1024;
									if(sizeImg > 1.5) {
										compressImage(entry.toLocalURL(), entry.name, value)
									} else {
										upload(entry.toLocalURL(), value);
									}
								}
							}
						}, function(e) {

						});
					}, function(e) {          
						mui.toast("读取照片错误：" + e.message);        
					});
				});
			}

			/**
			 * 压缩图片 
			 * @param {string} url：图片绝对路径
			 * @param {string} filename：图片名称
			 * @param {string} divid：图片容器id
			 */
			function compressImage(url, filename, value) {
				console.log(url); //file:///storage/emulated/0/Pictures/Screenshots/S70915-001739.jpg
				var path = "_doc/upload/" + filename; //_doc/upload/F_SMP-1467602809090.jpg  
				plus.zip.compressImage({
						src: url, //src: (String 类型 )压缩转换原始图片的路径  
						dst: path, //压缩转换目标图片的路径  
						quality: 20, //quality: (Number 类型 )压缩图片的质量.取值范围为1-100  
						overwrite: true //overwrite: (Boolean 类型 )覆盖生成新文件  
					},
					function(event) {
						//event.target获取压缩转换后的图片url路  
						console.log(event.target);
						upload(event.target, value);
					},
					function(error) {
						mui.toast("压缩图片失败，请稍候再试");
					});
			}

			var uploads = new Vue({
				el: '#uploads',
				data: {
					imgphoto01: "",
					imgphoto02: "",
					imgphoto03: "",
					imgphoto04: "",
				}
			});

			function getShow(value, p) {
				var url = "";
				if(value == "1") {
					url = uploads.imgphoto01;
					document.getElementById("issignimg01src").src = p;
				} else if(value == "2") {
					url = uploads.imgphoto02;
					document.getElementById("issignimg02src").src = p;
				} else if(value == "3") {
					url = uploads.imgphoto03;
					document.getElementById("issignimg03src").src = p;
				} else {
					url = uploads.imgphoto04;
					document.getElementById("issignimg04src").src = p;
				}

			}

			var isremove01 = "";
			var isremove02 = "";
			var isremove03 = "";
			var isremove04 = "";
			var removeAll = [];

			function upload(p, value) {
				var wt = plus.nativeUI.showWaiting();
				var task = plus.uploader.createUpload(api + addOrderPic, {
						method: "POST"
					},
					function(t, status) { //上传完成
						var objects = JSON.parse(t.responseText);
						if(objects.success) {
							imgNumber += 1;
							removeAll.push(objects.result.id);
							mui.toast(objects.message);
							if(value == "1") {
								isremove01 = objects.result.id;
								uploads.imgphoto01 = objects.result.pictureUrl;
								document.getElementById('issignimg01').style.display = 'block';
								document.getElementById('signimg01').style.display = 'none';
							} else if(value == "2") {
								isremove02 = objects.result.id;
								uploads.imgphoto02 = objects.result.pictureUrl;
								document.getElementById('issignimg02').style.display = 'block';
								document.getElementById('signimg02').style.display = 'none';
							} else if(value == "3") {
								isremove03 = objects.result.id;
								uploads.imgphoto03 = objects.result.pictureUrl;
								document.getElementById('issignimg03').style.display = 'block';
								document.getElementById('signimg03').style.display = 'none';
							} else {
								isremove04 = objects.result.id;
								uploads.imgphoto04 = objects.result.pictureUrl;
								document.getElementById('issignimg04').style.display = 'block';
								document.getElementById('signimg04').style.display = 'none';
							}
							var pulr = pictures + objects.result.pictureUrl
							getShow(value, pulr);
							wt.close();
						} else {
							mui.toast(objects.message);
							wt.close();
						}
					}
				);
				var s = onlyIds.toString()
				var islocation = false;
				task.addData("recordId", s);
				ajaxs(getOrderIsLocal + "?orderId=" + onlyIds, 'get').then(function(response) {
					loccodes = response.result.isLocation.code;
					if(response.result.isLocation.code == "YES") {
						islocation = true;
						plus.geolocation.getCurrentPosition(MapPoint, function(e) {
							mui.toast("error:" + e.message);
						}, {
							provider: 'gaode'
						})
					}
				}).catch(function(error) {

				})
				task.addFile(p, {
					key: "file"
				});
				
				setTimeout(() => {
					if(islocation) {
						console.log(addr)
						task.addData("watermark", addr);
					}
					task.addData("isLocal", loccodes);
					task.start();
				}, 500)
			}
		</script>
	</body>
	<script type="text/javascript" src="../js/immersed.js"></script>

</html>